From e374636d739e5c23c3125220d962c60eda541735 Mon Sep 17 00:00:00 2001
From: Adrien Kohlbecker <adrien.kohlbecker@gmail.com>
Date: Fri, 19 Oct 2018 21:52:37 +0200
Subject: [PATCH] Add postgresql and libffi dependency on ARM to
 datadog-agent-integrations

---
 .../config/software/datadog-agent-integrations.rb    | 12 ++++++++++--
 omnibus/lib/ostools.rb                               |  4 ++++
 2 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/omnibus/config/software/datadog-agent-integrations.rb b/omnibus/config/software/datadog-agent-integrations.rb
index aeb0cbfe..ed7e435e 100644
--- a/omnibus/config/software/datadog-agent-integrations.rb
+++ b/omnibus/config/software/datadog-agent-integrations.rb
@@ -11,6 +11,14 @@ name 'datadog-agent-integrations'
 dependency 'pip'
 dependency 'datadog-agent'
 
+if arm?
+  # psycopg2 doesn't come with pre-built wheel on the arm architecture.
+  # to compile from source, it requires the `pg_config` executable present on the $PATH
+  dependency 'postgresql'
+  # same with libffi to build the cffi wheel
+  dependency 'libffi'
+end
+
 if linux?
   # add nfsiostat script
   dependency 'unixodbc'
@@ -152,9 +160,9 @@ build do
       command("#{python_bin} -m #{python_pip_no_deps}\\datadog_checks_downloader --install-option=\"--install-scripts=#{windows_safe_path(install_dir)}/bin\"")
       command("#{python_bin} -m piptools compile --generate-hashes --output-file #{windows_safe_path(install_dir)}\\#{agent_requirements_file} #{static_reqs_filtered_file}")
     else
-      pip "install -c #{project_dir}/#{core_constraints_file} --no-deps .", :cwd => "#{project_dir}/datadog_checks_downloader"
+      pip "install -c #{project_dir}/#{core_constraints_file} --no-deps .", :env => nix_build_env, :cwd => "#{project_dir}/datadog_checks_downloader"
       pip "install -c #{project_dir}/#{core_constraints_file} --no-deps .", :env => nix_build_env, :cwd => "#{project_dir}/datadog_checks_base"
-      command("#{install_dir}/embedded/bin/python -m piptools compile --generate-hashes --output-file #{install_dir}/#{agent_requirements_file} #{static_reqs_filtered_file}")
+      command("#{install_dir}/embedded/bin/python -m piptools compile --generate-hashes --output-file #{install_dir}/#{agent_requirements_file} #{static_reqs_filtered_file}", :env => nix_build_env)
     end
 
     # Uninstall the deps that pip-compile installs so we don't include them in the final artifact
diff --git a/omnibus/lib/ostools.rb b/omnibus/lib/ostools.rb
index 87f2cd09..a76523e7 100644
--- a/omnibus/lib/ostools.rb
+++ b/omnibus/lib/ostools.rb
@@ -25,6 +25,10 @@ def windows?()
     return ohai['platform_family'] == 'windows'
 end
 
+def arm?()
+    return ohai['kernel']['machine'].start_with?('arm')
+end
+
 def os
     case RUBY_PLATFORM
     when /linux/
-- 
2.21.0

