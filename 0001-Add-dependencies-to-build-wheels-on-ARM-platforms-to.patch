From 003f99dc337294a63d7d20aa359d43c3cbb41768 Mon Sep 17 00:00:00 2001
From: Adrien Kohlbecker <adrien.kohlbecker@gmail.com>
Date: Fri, 19 Oct 2018 21:52:37 +0200
Subject: [PATCH] Add dependencies to build wheels on ARM platforms to
 datadog-agent-integrations

---
 .../config/software/datadog-agent-integrations.rb | 15 +++++++++++++--
 omnibus/lib/ostools.rb                            |  4 ++++
 2 files changed, 17 insertions(+), 2 deletions(-)

diff --git a/omnibus/config/software/datadog-agent-integrations.rb b/omnibus/config/software/datadog-agent-integrations.rb
index 5256fb2a..0ef737be 100644
--- a/omnibus/config/software/datadog-agent-integrations.rb
+++ b/omnibus/config/software/datadog-agent-integrations.rb
@@ -12,6 +12,17 @@ dependency 'datadog-agent'
 dependency 'pip2'
 dependency 'pip3'
 
+if arm?
+  # psycopg2 doesn't come with pre-built wheel on the arm architecture.
+  # to compile from source, it requires the `pg_config` executable present on the $PATH
+  dependency 'postgresql'
+  # same with libffi to build the cffi wheel
+  dependency 'libffi'
+  # same with libxml2 and libxslt to build the lxml wheel
+  dependency 'libxml2'
+  dependency 'libxslt'
+end
+
 if linux?
   # add nfsiostat script
   dependency 'unixodbc'
@@ -140,8 +151,8 @@ build do
       command "#{python2} -m piptools compile --generate-hashes --output-file #{windows_safe_path(install_dir)}\\#{agent_requirements_file} #{static_reqs_out_file}"
     else
       command "#{pip2} install --no-deps .", :env => nix_build_env, :cwd => "#{project_dir}/datadog_checks_base"
-      command "#{pip2} install --no-deps .", :cwd => "#{project_dir}/datadog_checks_downloader"
-      command "#{python2} -m piptools compile --generate-hashes --output-file #{install_dir}/#{agent_requirements_file} #{static_reqs_out_file}"
+      command "#{pip2} install --no-deps .", :env => nix_build_env, :cwd => "#{project_dir}/datadog_checks_downloader"
+      command "#{python2} -m piptools compile --generate-hashes --output-file #{install_dir}/#{agent_requirements_file} #{static_reqs_out_file}", :env => nix_build_env
     end
 
     # From now on we don't need piptools anymore, uninstall its deps so we don't include them in the final artifact
diff --git a/omnibus/lib/ostools.rb b/omnibus/lib/ostools.rb
index 87f2cd09..da214c40 100644
--- a/omnibus/lib/ostools.rb
+++ b/omnibus/lib/ostools.rb
@@ -25,6 +25,10 @@ def windows?()
     return ohai['platform_family'] == 'windows'
 end
 
+def arm?()
+    return ohai["kernel"]["machine"].start_with?("aarch") || ohai["kernel"]["machine"].start_with?("arm")
+end
+
 def os
     case RUBY_PLATFORM
     when /linux/
-- 
2.21.0

